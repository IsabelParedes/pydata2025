<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/astro.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&family=Merriweather+Sans&display=swap" rel="stylesheet">
    <title>QuantStack</title>
    <style>
    </style>
  </head>
  <body>
    <script type="module" src="/src/main.ts"></script>
    <div class="reveal">
		<div class="slides">

        <section data-background="./abstract_main.jpg">
          <h1 class="main-title">Expanding Programming Language Support in JupyterLite</h1>
          <img src="/src/images/logo_scientific_computing.svg" alt="QuantStack Logo" class="title-logo">
        </section>

        <section class="cosmo-slide">
          <img src="/src/images/cosmo_pkg_emforge.png" alt="QuantStack Logo" class="cosmo-img">
          <h2 class="main-title">Introduction to Emscripten-Forge</h1>
        </section>

        <section>
          <h2>What is emscripten?</h2>
          <div class="two-column">
            <div class="column">
              <ul>
                <li>Toolchain to compile C/C++/Fortran to WebAssembly</li>
                <li>Based on LLVM and Clang</li>
                <li>Runs code in browsers and Node.js</li>
              </div>
            <div class="column">
              <img src="/src/images/Emscripten_logo.svg" alt="Emscripten logo" style="width: 70%;">
            </div>
          </div>
        </section>

        <section>
          <h2>Use Cases</h2>
          Emscripten can compile a wide variety of applications to WebAssembly.
          <div class="two-column">
            <div class="column">
              <h2>DOOM</h2>
              <img src="/src/images/doom.jpg" alt="DOOM game screenshot" style="width: 70%;">
              <p style="font-size: 0.7em;"><a href="https://silentspacemarine.com/" target="_blank">doom-wasm</a></p>
            </div>
            <div class="column">
              <h2>Python</h2>
              <img src="/src/images/repl_pyodide.png" alt="Python logo" style="width: 70%;">
              <p style="font-size: 0.7em;"><a href="https://pyodide.org/en/stable/" target="_blank">pyodide</a></p>
            </div>
          </div>
        </section>
                      

        <section>
          <h2>Use Cases</h2>
          Emscripten can compile a wide variety of applications to WebAssembly.
          <div class="two-column">
            <div class="column">
              <h2>LLVM / Clang</h2>
              <img src="/src/images/llvm_wyvern.png" alt="LLVM / Clang logo" style="width: 70%;">
              <p style="font-size: 0.7em;"><a href="https://prefix.dev/channels/emscripten-forge-dev/packages/llvm" target="_blank">llvm.wasm</a></p>
            </div>
            <div class="column">
              <h2>OS Emulation</h2>
              <img src="/src/images/x86emu.jpg" alt="copy.sh screenshot" style="width: 70%;">
              <p style="font-size: 0.7em;"><a href="https://copy.sh" target="_blank">copy.sh</a></p>

            </div>
          </div>
        </section>


        <section>
          <h2>What is conda-forge?</h2>
          <div class="two-column">
            <div class="column">
              <ul>
                <li>Distribution for conda packages</li>
                <li>Community driven</li>
                <li>Language agnostic</li>
                <li>Multi platform</li>
                <ul>
                  <li>Linux</li>
                  <li>macOS</li>
                  <li>Windows</li>
                  <li class="fragment">
                   wasm is missing!
                  </li>
                </ul>
                </ul>
              </div>
            <div class="column">
              <img src="/src/images/logo_black_on_trans.png" alt="Conda forge logo" style="width: 70%;">
            </div>
          </div>
        </section>
                      
        <section>
          <h2>What is emscripten-forge?</h2>
          <div class="two-column">  
            <div class="column">
              <ul>
                <li>Distribution for conda packages</li>
                <li>Specifically targets the <strong>emscripten-wasm32</strong> platform</li>
                <li>Community-driven recipes</li>
                <li>Enables running C, C++, Fortran, Python, R, Lua and Octave  in the browser
                  <div class="fragment">
                     <bold>and in  jupyterlite</bold>
                  </div>
                </li>

                
              </ul>
            </div>
            <div class="column">
              <img src="/src/images/logo_emscripten_forge.svg" alt="Emscripten forge logo" style="width: 70%;">
              <p style="font-size: 0.7em;"><a href="https://emscripten-forge.org/" target="_blank">emscripten-forge.org</a></p>
            </div>
          </div>
        </section>

        

        <section class="cosmo-slide">
          <img src="/src/images/cosmo_victory_jlite.png" alt="QuantStack Logo" class="cosmo-img">
          <h2 class="main-title">Xeus Kernels in JupyterLite</h1>
        </section>


        <section>
          <h3>Jupyter Architecture</h3>
            <div class="two-column">
              <div class="column">
                <div class="mermaid">
                  <pre>
                  %%{init: {'look':'handDrawn','theme': 'default', 'themeVariables': { 'darkMode': true }}}%%
                  graph LR
                    subgraph MyBox["Jupyter"]
                      
                      subgraph KernelProcess["Kernel Process"]
                          kernel[Kernel]
                      end

                      subgraph ServerProcess["Server Process"]
                          server[Server]
                      end

                      subgraph FrontendProcess["Browser"]
                          frontend[Frontend]
                      end

                      kernel -- zmq  --> server -- websockets --> frontend

                    end
                  </pre>
                </div>
              </div>
              <div class="column">
                <ul>
                  <li>Multiple processes</li>
                  <li>Kernel and Server communicate via <code>zmq</code></li>
                  <li>Server and Frontend communicate via <code>websockets</code></li>
                </ul>
              </div>
            </div>
        </section>

        <section>
          <h3>Jupyterlite Architecture</h3>
 
            <div class="two-column">
              <div class="column">
                <div class="mermaid">
                  <pre>
                    %%{init: {'look':'handDrawn', 'theme': 'default', 'themeVariables': { 'darkMode': false}}}%%
                  graph LR

                  
                    subgraph MyBox["Jupyterlite"]
          
              
                      subgraph WebWorker["WebWorker"]
                          kernel2[Kernel]
                      end

                      subgraph MainThread["MainThread"]
                          server2[Server] --> frontend2[Frontend]
                      end

                      kernel2 -- postMessage --> server2
                    end

                  </pre>
                </div>
              </div>
              <div class="column">
                <ul>
                  <li>Everything runs in the browser</li>
                  <li>Kernel runs in separate <code>WebWorker</code></li>
                  <li>Communication between Kernel and Server via <code>postMessage</code></li>
                </ul>
              </div>
            </div>
        </section>

        <section>
          <h3>Architecture Comparison</h3>
          <div class="two-column">
            <div class="mermaid">
              <pre>
              %%{init: {'look':'handDrawn','theme': 'default', 'themeVariables': { 'darkMode': true }}}%%
              graph LR
                subgraph MyBox["Jupyter"]
                  
                  subgraph KernelProcess["Kernel Process"]
                      kernel[Kernel]
                  end

                  subgraph ServerProcess["Server Process"]
                      server[Server]
                  end

                  subgraph FrontendProcess["Browser"]
                      frontend[Frontend]
                  end

                  kernel -- zmq  --> server -- websockets --> frontend

                end
              </pre>
            </div>
            <div class="mermaid">
              <pre>
              %%{init: {'look':'handDrawn', 'theme': 'default', 'themeVariables': { 'darkMode': false }}}%%
              graph LR

              
                subgraph MyBox["Jupyterlite"]
       
           
                  subgraph WebWorker["WebWorker"]
                      kernel2[Kernel]
                  end

                  subgraph MainThread["MainThread"]
                      server2[Server] -- js --> frontend2[Frontend]
                  end

                  kernel2 --> server2
                end

              </pre>
            </div>
          </div>
        </section>

        

        <section>

       
          <div class="two-column">
            <div class="column">
              <h3>The kernel:</h3>
              <ul>
                <li>most important part of Jupyter</li>
                <li>executes the code</li>
                <li>multiple kernels available</li>
                <li>can be implemented ontop of xeus:</li>
                <ul>
                  <li>c++ library to author kernels</li>
                  <li>handles the Jupyter messaging protocol</li>
                  <li>provides abstractions for common tasks</li>
                </ul>
              </ul>
            </div>
            <div class="column">
              <div class="fragment">
                <h3>xeus based kernels:</h3>
                <ul>
                  <li class="fragment">xeus-python</li>
                    <li class="fragment">xeus-lua</li>
                    <li class="fragment">xeus-sqlite</li>
                    <li class="fragment">xeus-ocaml</li>
                    <li class="fragment">xeus-javascript</li>
                    <li class="fragment">xeus-r</li>
                    <li class="fragment">xeus-octave</li>
                    <li class="fragment">xeus-cpp </li>
                </ul>
              </div>
            </div>
          </div>
        </section> 



        <section class="cosmo-slide">
          <img src="/src/images/cosmo_rock_r.png" alt="QuantStack Logo" class="cosmo-img">
          <h2 class="main-title">Packaging R for WebAssembly</h1>
        </section>

        <section>
          <h2>WebR</h2>
          <div class="two-column">
            <div class="column">
              <ul>
                <li>Emscripten</li>
                <li>Fortran compiler</li>
                <ul>
                  <li>Custom development version of <strong>LLVM Flang</strong> (v18)</li>
                  <li>GCC and Dragonegg</li>
                </ul>
              </ul>
            </div>
            <div class="column">
                <img src="/src/images/webr.png"
                  alt="webr logo - purple webassembly square with R-wa">
                <img src="/src/images/rwasm.png"
                  alt="rwasm logo - truck with packages">
            </div>
          </div>
        </section>

        <section>
          <h2>Core Dependencies of R</h2>
          <div class="two-column">
            <div class="column-top-align">
              <img src="/src/images/c_logo.svg" alt="C language logo" style="height: 4em;">
              <div style="display: flex; flex-direction: row;">
                <div style="padding: 1em;"><ul>
                  <li>Required</li>
                  <ul>
                    <li><code>libiconv</code></li>
                    <li><code>zlib</code></li>
                    <li><code>bzip2</code></li>
                    <li><code>lzma</code></li>
                    <li><code>pcre2</code></li>
                  </ul>
                  <ul style="list-style-type: '❌ ';">
                    <li><code>libcurl</code></li>
                  </ul>
                </ul></div>
                <div style="padding: 1em;"><ul>
                  <li>Optional</li>
                  <ul>
                    <li><code>libpng</code></li>
                    <li><code>cairo</code></li>
                    <li><code>libtiff</code></li>
                    <li><code>glib</code></li>
                  </ul>
                </ul></div>
              </div>
            </div>
            <div class="column-top-align">
              <img src="/src/images/fortran_logo.svg" alt="Fortran language logo" style="height: 4em;">
              <ul>
                <li style="margin: 2em 0 0">Required</li>
                <ul>
                  <li>BLAS / LAPACK</li>
                </ul>
                <li style="margin: 1em 0 0;">R packages</li>
                <ul>
                  <li><code>nlme</code></li>
                </ul>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h2>Fortran to WebAssembly</h2>
          <div class="two-column">
            <div class="column">
              <h3>LLVM Flang</h3>
              <ul>
                <li>Modern LLVM Integration</li>
                <li>Active Development</li>
                <li>LLVM backend to target WebAssembly</li>
              </ul>
            </div>
            <div class="column">
              <img src="/src/images/llvm_wyvern.png" alt="LLVM logo of wyvern dragon">
            </div>
          </div>
        </section>

        <section>
          <h2>LLVM Flang</h2>
          <div class="two-column">
            <div class="column">
              <video src="/src/videos/digits.webm" autoplay loop muted playsinline style="margin-bottom: 1rem; box-shadow: 0 0 10px rgba(0, 0, 0, 0.35);"></video>
              <p><a href="https://gws.phd/posts/fortran_wasm/" target="_blank"><strong>Fortran on WebAssembly</strong>: Patching LLVM Flang to output WebAssembly objects</a></p>
              <p>by George Stagg</p>
            </div>
            <div class="column" style="width: 55%;">
              <h3>Serge Guelton</h3>
              <ul>
                <li style="margin: 0;">Upstreamed contributions:</li>
                <ul>
                  <li><a href="https://github.com/llvm/llvm-project/pull/99465">Fix implicit conversion warning when targeting 32bit systems</a></li>
                  <li><a href="https://github.com/llvm/llvm-project/pull/99822">Explicitly convert shift value to SubscriptValue</a></li>
                  <li><a href="https://github.com/llvm/llvm-project/pull/101242">Handle missing definitions in cfenv</a></li>
                  <li><a href="https://github.com/llvm/llvm-project/pull/105589">Fix type used to store result of typeInfo::Value::GetValue</a></li>
                </ul>
                <li style="margin: 0;">Additional patches (v19):</li>
                <ul>
                  <li><a href="https://github.com/conda-forge/flang-feedstock/blob/emscripten/recipe/patches/0002-Minimal-WASM-support-for-flang.patch">Minimal WASM support for Flang</a></li>
                  <li><a href="https://github.com/conda-forge/flang-feedstock/blob/emscripten/recipe/patches/0003-Specialize-Flang-to-target-WASM.patch">Specialize Flang to target WASM</a></li>
                  <li><a href="https://github.com/conda-forge/flang-feedstock/blob/emscripten/recipe/patches/0004-Disable-float128-math.patch">Disable <code>float128</code> math</a></li>
                </ul>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h2>LLVM Flang (v20)</h2>
          <div class="single-column">
            <img src="/src/images/conda-forge_flang.png" alt="Screenshot of flang feedstock repo on conda-forge" class="img-shadow" style="max-width: 60%;">
            <p><a href="https://github.com/conda-forge/flang-feedstock/tree/emscripten" target="_blank">github.com/conda-forge/flang-feedstock/tree/emscripten</a></p>
            <pre><code data-trim class="language-bash">
            micromamba install conda-forge/label/emscripten::flang --no-channel-priority
            </code></pre>
          </div>
        </section>

        <section>
          <h2>Assembling the Toolchain</h2>
          <img src="/src/images/toolchain.svg" alt="Diagram of Fortran and C/C++ to WebAssembly toolchain with Emscripten and Flang">
        </section>

        <section>
          <h2>Cross-Compilation of R</h2>
          <div class="single-column">
          <ul>
            <li><strong>Phase 1:</strong> Host</li>
            <ul>
              <li>Build a minimal native version of R for Linux with GCC and Flang</li>
              <li>This generates the tools required for Phase 2 (R and Rscript executables)</li>
            </ul>
            <li><strong>Phase 2:</strong> Target</li>
            <ul>
              <li>Cross-compile to WebAssembly with Emscripten and Flang</li>
            </ul>
          </ul></div>
        </section>

        <section>
          <h2>Modifications to R Source Code</h2>
          <div class="single-column">
            <ul>
              <li>Add <code>wasm32-unknown-emscripten</code> as a recognized target platform</li>
              <li>Use <code>R</code> and <code>Rscript</code> executables from Phase 1</li>
              <li>Load the shared libraries from Phase 1</li>
              <ul>
                <li>Required to create the R Data Base (<code>.rdb</code>) and R Data Index (<code>.rdx</code>) files</li>
                <li>Package <code>cross-r-base_emscripten-wasm32</code></li>
              </ul>
              <li>Remove dependency on <code>libcurl</code></li>
              <ul>
                <li>Disable <code>internet</code> package</li>
              </ul>
              <li>Set default graphics device to <code>cairo</code> instead of <code>X11</code></li>
            </ul>
          </div>
          <p><a href="https://github.com/emscripten-forge/recipes/tree/main/recipes/recipes_emscripten/r-base/patches" target="_blank">[full list of patches]</a></p>
        </section>

        <section>
          <h2><code>r-base</code></h2>
          <div class="two-column" style="min-height: 60%;">
            <div class="column" style="width: 50%;">
              <p><a href="https://github.com/emscripten-forge/recipes/blob/main/recipes/recipes_emscripten/r-base/recipe.yaml" target="_blank"><code>recipe.yaml</code></a></p>
              <pre><code data-trim data-line-numbers class="language-yaml">
                context:
                  name: r-base
                  version: 4.5.1

                package:
                  name: ${{ name }}
                  version: ${{ version }}

                source:
                  url: https://cran.r-project.org/src/base/R-4/R-${{ version }}.tar.gz
                  sha256: b42a7921400386645b10105b91c68728787db5c4c83c9f6c30acdce632e1bb70
                  patches:
                  - patches/0001-Add-emscripten-platform-to-configure-script.patch
                  - patches/0002-Disable-libcurl.patch
                  - patches/0003-Disable-internet-module.patch
                  - patches/0004-Fix-iconv-checks-when-using-internal-lapack-blas.patch
                  - patches/0005-Add-sigsuspend-stub-for-Emscripten-compatibility.patch
                  - patches/0006-Disable-which-for-emscripten.patch
                  - patches/0007-Set-cairo-as-default-bitmap-type.patch
                  - patches/0008-Use-source-files-directly.patch
                  - patches/0009-Install-.wasm-files.patch
                  - patches/0010-Fix-extern-C-error-expected-an-identifier.patch
                  - patches/0011-Remove-png-lib-from-bitmap-libs.patch
                  - patches/0012-Use-linux-executables.patch
                  - patches/0013-Use-source-files-when-installing.patch

                build:
                  number: 0

                requirements:
                  build:
                  - ${{ compiler('c') }}
                  - ${{ compiler('cxx') }}
                  - flang_emscripten-wasm32
                  - libtool
                  - pkg-config
                  - cmake
                  - make
                  # Dependencies to build R in the build environment
                  - gcc
                  - libiconv
                  - zlib
                  - bzip2
                  - xz
                  - pcre2
                  - libpng
                  - libtiff
                  - cairo
                  host:
                  - libflang
                  - libiconv
                  - zlib
                  - bzip2
                  - xz
                  - pcre2
                  - libpng
                  - libtiff
                  - cairo
                  - fontconfig
                  - pixman
                  - expat
                  - freetype

                tests:
                - package_contents:
                    lib:
                    - R/lib/libR.a
                    - R/lib/libRblas.so
                    - R/lib/libRlapack.so
                    - R/library/grDevices/libs/cairo.so
                - script:
                  - node ${PREFIX}/lib/R/bin/Rscript --version
                  requirements:
                    build:
                    - nodejs

                about:
                  homepage: http://www.r-project.org/
                  license: GPL-2.0-or-later
                  license_family: GPL
                  license_file: COPYING
                  summary: |
                    R is a free software environment for statistical computing and graphics.
              </code></pre>
            </div>
            <div class="column" style="width: 50%;">
              <p><a href="https://github.com/emscripten-forge/recipes/blob/main/recipes/recipes_emscripten/r-base/build.sh" target="_blank"><code>build.sh</code></a></p>
              <pre><code data-trim data-line-numbers class="language-bash">
              #-------------------------------------------------------------------------------
              # PHASE 1
              #-------------------------------------------------------------------------------
              # Building R for Linux so that we can use the R and Rscript binaries to build
              # the R internal modules for WebAssembly.

              mkdir -p _build_linux
              pushd _build_linux
              (
                  export PKG_CONFIG_PATH=$BUILD_PREFIX/lib/pkgconfig
                  export PREFIX=$BUILD_PREFIX
                  export CC=gcc
                  export CXX=g++
                  export FC=flang-new
                  export CPPFLAGS="-I$BUILD_PREFIX/include"
                  export LDFLAGS="-L$BUILD_PREFIX/lib"
                  export FC_LEN_T=size_t
                  export LINUX_BUILD_DIR=$(pwd)

                  ../configure \
                      --prefix=$BUILD_PREFIX \
                      $CONFIG_ARGS

                  make -j${CPU_COUNT}
                  # No need to install, we just need the R binary
              )
              popd

              #-------------------------------------------------------------------------------
              # PHASE 2
              #-------------------------------------------------------------------------------
              # Building R for WebAssembly using the R binary from the Linux build.

              mkdir -p _build_wasm
              pushd _build_wasm
              (
                  cp $RECIPE_DIR/config.site .

                  export CROSS_COMPILING="true"
                  export R_EXECUTABLE=$(realpath ..)/_build_linux/bin/exec/R # binary not shell wrapper
                  export R_SCRIPT_EXECUTABLE=$(realpath ..)/_build_linux/bin/Rscript
                  export LINUX_BUILD_DIR=$(realpath ..)/_build_linux
                  export WASM_BUILD_DIR=$(pwd)

                  emconfigure ../configure \
                      --prefix=$PREFIX    \
                      --build="x86_64-conda-linux-gnu" \
                      --host="wasm32-unknown-emscripten" \
                      $CONFIG_ARGS

                  emmake make -j${CPU_COUNT}

                  $RECIPE_DIR/cross_libraries.sh --restore $(pwd)

                  emmake make install

              )
              popd
              </code></pre>
            </div>
          </div>
          <img src="/src/images/package-r.svg" alt="Cardboard box with R language logo" height="30%">
        </section>

        <section>
          <h2>Expanding the R Ecosystem</h2>
          <div class="two-column">
            <div class="column" style="width: 60%;">
              <ul>
                <li>Pure R packages, "<strong>noarch</strong>" packages, from <code>conda-forge</code> work instantly</li>
                <li>Packages that need to be compiled require new recipes on <code>emscripten-forge</code></li>
                <ul>
                  <li><code>r-askpass</code></li>
                  <li><code>r-base64enc</code></li>
                  <li><code>r-cachem</code></li>
                  <li><code>r-cli</code></li>
                  <li><code>r-nlme</code></li>
                  <li><code>r-rlang</code></li>
                  <li>... and many more</li>
                </ul>
              </ul>
            </div>
            <div class="column">
              <pre><code data-trim data-line-numbers="11|15" class="language-yaml">
              package:
                name: r-bit
                version: 4.6.0

              source:
                url: https://cran.r-project.org/src/contrib/bit_4.6.0.tar.gz
                sha256: 48fe21c5d04c7b724d695eeb60074395c0c631a7fb234e2075de92471445de08

              build:
                number: 0
                script: $R CMD INSTALL $R_ARGS .

              requirements:
                build:
                  - cross-r-base_emscripten-wasm32
                  - ${{ compiler('c') }}
                  - r-base
                host:
                  - r-base
                run:
                  - r-base
              </code></pre>
            </div>
          </div>
        </section>

        <section>
          <h2>Xeus-R</h2>
          <div class="two-column">
            <div class="column">
              <ul>
                <li>Author: <a href="https://github.com/romainfrancois" target="_blank">Romain François</a></li>
                <li>Powered by <code>xeus</code></li>
              </ul>
              <p></p>
              <img src="/src/images/xeus-r-logo.svg" alt="Xeus-R logo" width="90%">
            </div>
            <div class="column">
              <img src="/src/images/xeus-r-lab.png" class="img-shadow" alt="Example Jupyter notebook for Xeus-R kernel">
            </div>
          </div>
        </section>

        <section>
          <h2>Xeus-R</h2>
          <div class="two-column">
            <div class="column">
              <img src="/src/images/package-xeus-r.svg" alt="Cardboard box of xeus-r package" width="80%">
            </div>
            <div class="column">
              <pre style="width: 100%;"><code data-trim data-line-numbers class="language-yaml">
              package:
                name: xeus-r
                version: 0.8.1

              source:
                url: https://github.com/jupyter-xeus/xeus-r/archive/refs/tags/${{ version }}.tar.gz
                sha256: 032fe1e337b67bb35b965a8d7535a3a1cd1c0e69e74d03af12acde06b4b83490

              build:
                number: 0

              requirements:
                build:
                - ${{ compiler("cxx") }}
                - cmake
                - make
                # Dependencies to build hera
                - cross-r-base_${{ target_platform }}
                - r-base == ${{ r_base_version }}
                - r-cli
                - r-evaluate
                - r-glue
                - r-IRdisplay
                - r-R6
                - r-repr
                host:
                - nlohmann_json
                - nlohmann_json-abi
                - xeus
                - xeus-lite
                - pcre2
                - zlib
                - libflang
                - xz
                - bzip2
                - libiconv
                - r-base
                run:
                - r-base
                - r-cli
                - r-evaluate
                - r-glue
                - r-IRdisplay
                - r-jsonlite
                - r-R6
                - r-repr
                - r-rlang

              tests:
              - package_contents:
                  files:
                  - bin/xr.js
                  - bin/xr.wasm

              about:
                license: GPL-3.0-only
                license_family: GPL
                license_file: LICENSE
                summary: Jupyter kernel for the R programming language
                homepage: https://github.com/jupyter-xeus/xeus-r
                documentation: https://xeus-r.readthedocs.io
              </code></pre>
              <p></p>
              <p><a href="https://github.com/emscripten-forge/recipes/blob/main/recipes/recipes_emscripten/xeus-r/recipe.yaml" target="_blank">recipe.yaml</a></p>
            </div>
          </div>
        </section>

        <section>
          <h2>Xeus-R-Lite</h2>
          <div class="jlite-iframe">
            <iframe src="https://isabelparedes.github.io/pydata2025-r/lab/?path=demo.ipynb" width="100%" height="100%" style="border: none;"></iframe>
          </div>
          <p style="font-size: 0.5em;"><a href="https://isabelparedes.github.io/pydata2025-r/lab/?path=demo.ipynb" target="_blank">[open in new tab]</a></p>
        </section>

        <section class="cosmo-slide">
          <img src="/src/images/cosmo_pkg_walk_octave.png" alt="QuantStack Logo" class="cosmo-img">
          <h2 class="main-title">Packaging GNU Octave for WebAssembly</h1>
        </section>

        <section>
          <h2>What is GNU Octave?</h2>
          <div class="two-column">
            <div class="column">
              <img src="/src/images/octave-logo.svg" alt="GNU Octave logo" width="70%">
            </div>
            <div class="column" style="width: 60%;">
              <ul>
                <li>Scientific programming language</li>
                <li>Mathematics-oriented syntax</li>
                <li>Drop-in compatible with MATLAB</li>
                <li>Free and open-source</li>
              </ul>
              <pre><code data-trim class="language-matlab" style="width: 40%; margin-left: 30%;">
              b = [4; 9; 2]
              A = [ 3 4 5;
                    1 3 1;
                    3 5 9 ]
              x = A \ b
              </code></pre>
            </div>
          </div>
        </section>

        <section>
          <h2>Cross-Compilation of GNU Octave</h2>
          <div class="two-column">
            <div class="column" style="width: 45%;">
              <ul style="list-style-type: '✅  ';">
                <li>C/C++ compiler: Emscripten</li>
                <li>Fortran compiler: LLVM Flang</li>
              </ul>
              <p></p>
              <div style="width: 90%; text-align: left;"><h3>Dependencies:</h3>
              <ul>
                <li>Fortran runtime library</li>
                <li>BLAS/LAPACK</li>
                <ul>
                  <li>Netlib LAPACK</li>
                  <li>OpenBLAS</li>
                </ul>
                <li><code>pcre2</code></li>
                <li><code>freetype</code></li>
              </ul>
              </div>
            </div>
            <div class="column" style="width: 55%;">
              <img src="/src/images/package-octave.svg" alt="Cardboad box of GNU Octave package" width="40%">
              <p></p>
              <div style="width: 90%; text-align: left;"><h3>Modifications:</h3></div>
              <ul>
                <li>Add <code>wasm32-unknown-emscripten</code> support</li>
                <li>Disable GUI functionality</li>
              </ul>
            </div>
          </div>
        </section>

        <section>
          <h2>Fortran Challenges</h2>
          <div class="two-column">
            <div class="column" style="width: 40%;">
              <pre style="width: 100%;"><code data-trim data-line-numbers="11" class="language-fortran">
              C-----------------------------------------------------------------------
              C The following internal Common block contains
              C (a) variables which are local to any subroutine but whose values must
              C     be preserved between calls to the routine ("own" variables), and
              C (b) variables which are communicated between subroutines.
              C The block SLS001 is declared in subroutines SLSODE, SINTDY, SSTODE,
              C SPREPJ, and SSOLSY.
              C Groups of variables are replaced by dummy arrays in the Common
              C declarations in routines where those variables are not used.
              C-----------------------------------------------------------------------
                    COMMON /SLS001/ CONIT, CRATE, EL(13), ELCO(13,12),
                  1   HOLD, RMAX, TESCO(3,12),
                  1   CCMAX, EL0, H, HMIN, HMXI, HU, RC, TN, UROUND,
                  2   INIT, MXSTEP, MXHNIL, NHNIL, NSLAST, NYH,
                  3   IALTH, IPUP, LMAX, MEO, NQNYH, NSLP,
                  3   ICF, IERPJ, IERSL, JCUR, JSTART, KFLAG, L,
                  4   LYH, LEWT, LACOR, LSAVF, LWM, LIWM, METH, MITER,
                  5   MAXORD, MAXCOR, MSBP, MXNCF, N, NQ, NST, NFE, NJE, NQU
              C
                    DATA  MORD(1),MORD(2)/12,5/, MXSTP0/500/, MXHNL0/10/
              </code></pre>
              <p></p>
              <p style="font-size: 0.8em;"><code>liboctave/external/odepack/slsode.f</code></p>
            </div>
            <div class="column" style="width: 55%;">
              <pre style="width: 100%;"><code data-trim data-line-numbers class="language-cpp">
              void MCWasmStreamer::emitCommonSymbol(MCSymbol *S, uint64_t Size,
                                                    Align ByteAlignment) {
                llvm_unreachable("Common symbols are not yet implemented for Wasm");
              }
              </code></pre>
              <p></p>
              <p style="font-size: 0.8em;"><a href="https://github.com/llvm/llvm-project/blob/bba91727789bed302758dac282107a44c7b33504/llvm/lib/MC/MCWasmStreamer.cpp#L132" target="_blank"><code>llvm/lib/MC/MCWasmStreamer.cpp</code></a></p>
            </div>
          </div>
        </section>

        <section>
          <h2>Patching LLVM</h2>
          <div class="single-column">
          <pre><code data-trim data-line-numbers class="language-diff"  style="max-height: 500px;">
          From 703b5fa8bd61289c8664ef603da8c502cb595ac7 Mon Sep 17 00:00:00 2001
          From: serge-sans-paille <sguelton@mozilla.com>
          Date: Tue, 8 Jul 2025 17:02:04 +0200
          Subject: Simulate common symbols as weak

          ---
          llvm/lib/MC/MCWasmStreamer.cpp | 12 ++++++++++--
          1 file changed, 10 insertions(+), 2 deletions(-)

          diff --git a/llvm/lib/MC/MCWasmStreamer.cpp b/llvm/lib/MC/MCWasmStreamer.cpp
          index 8560f0ebe..f8a83e01a 100644
          --- a/llvm/lib/MC/MCWasmStreamer.cpp
          +++ b/llvm/lib/MC/MCWasmStreamer.cpp
          @@ -150,7 +150,11 @@ bool MCWasmStreamer::emitSymbolAttribute(MCSymbol *S, MCSymbolAttr Attribute) {

          void MCWasmStreamer::emitCommonSymbol(MCSymbol *S, uint64_t Size,
                                                Align ByteAlignment) {
          -  llvm_unreachable("Common symbols are not yet implemented for Wasm");
          +  // llvm_unreachable("Common symbols are not yet implemented for Wasm");
          +  auto *Symbol = cast<MCSymbolWasm>(S);
          +  getAssembler().registerSymbol(*Symbol);
          +  Symbol->setWeak(true);
          +  Symbol->setExternal(true);
          }

          void MCWasmStreamer::emitELFSize(MCSymbol *Symbol, const MCExpr *Value) {
          @@ -159,7 +163,11 @@ void MCWasmStreamer::emitELFSize(MCSymbol *Symbol, const MCExpr *Value) {

          void MCWasmStreamer::emitLocalCommonSymbol(MCSymbol *S, uint64_t Size,
                                                      Align ByteAlignment) {
          -  llvm_unreachable("Local common symbols are not yet implemented for Wasm");
          +  // llvm_unreachable("Local common symbols are not yet implemented for Wasm");
          +  auto *Symbol = cast<MCSymbolWasm>(S);
          +  getAssembler().registerSymbol(*Symbol);
          +  Symbol->setWeak(true);
          +  Symbol->setExternal(true);
          }

          void MCWasmStreamer::emitIdent(StringRef IdentString) {
          </code></pre>
          </div>
          <p>Partial support for common linkage for WebAssembly (<a href="https://github.com/llvm/llvm-project/pull/151478" target="_blank">llvm-project/pull/151478</a>)</p>
        </section>

        <section>
          <h2>Xeus-Octave</h2>
          <div class="two-column">
            <div class="column">
              <ul>
                <li>Authors:</li>
                <ul>
                  <li><a href="https://github.com/AntoinePrv" target="_blank">Antoine Prouvost</a></li>
                  <li><a href="https://github.com/rapgenic" target="_blank">Giulio Girardi</a></li>
                </ul>
                <li>Powered by <code>xeus</code></li>
              </ul>
              <p></p>
              <img src="/src/images/xeus-octave-logo.svg" alt="Xeus-Octave logo" width="90%">
            </div>
            <div class="column">
              <img src="/src/images/xeus-octave-lab.png" class="img-shadow" alt="Example Jupyter notebook for Xeus-Octave kernel">
            </div>
          </div>
        </section>

        <section>
          <h2>Xeus-Octave-Lite</h2>
          <div class="jlite-iframe">
            <iframe src="https://isabelparedes.github.io/pydata2025-octave/lab/?path=demo.ipynb" width="100%" height="100%" style="border: none;"></iframe>
          </div>
          <p style="font-size: 0.5em;"><a href="https://isabelparedes.github.io/pydata2025-octave/lab/?path=demo.ipynb" target="_blank">[open in new tab]</a></p>
        </section>

        <section>
          <h2>Expanding the GNU Octave Ecosystem</h2>
          <div class="single-column" style="padding: 3em;">
            <div style="text-align: left; width: 100%;"><h3>Future plans</h3></div>
            <ul>
              <li>Add pure Octave packages to <code>conda-forge</code> as <strong>noarch</strong> packages</li>
              <li>Add Octave packages to <code>emscripten-forge</code>, those which require compilation</li>
            </ul>
            <img src="/src/images/packages.svg" alt="Four cardboard boxes as packages" width="30%">
          </div>
        </section>

        <section class="cosmo-slide">
          <img src="/src/images/cosmo_fly.png" alt="QuantStack Logo" class="cosmo-img">
          <h2 class="main-title">JupyterLite Terminal</h1>
        </section>

        <section>
          <h2>Terminal</h2>
          <div style="margin: 1em;">
          <h3>In JupyterLab</h3>
            <ul>
              <li>Terminal connects to a real shell running on the server</li>
            </ul>
          </div>
          <div style="margin: 1em;">
          <h3>In JupyterLite</h3>
            <ul>
              <li>Terminal connects to a shell emulator running in the browser</li>
              <li>Mixture of TypeScript and WebAssembly</li>
              <li>Two projects
                <ul>
                  <li><a href="https://github.com/jupyterlite/cockle">cockle</a>: standalone shell without any JupyterLite dependencies</li>
                  <li><a href="https://github.com/jupyterlite/terminal">terminal</a>: JupyterLite extension using cockle</li>
                </ul>
              </li>
            </ul>
          </div>
        </section>

        <section>
          <h2>Demo of JupyterLite Terminal</h2>
          <div class="jlite-iframe">
            <iframe src="https://jupyterlite.github.io/terminal" width="100%" height="100%" style="border: none;"></iframe>
          </div>
          <p style="font-size: 0.5em;"><a href="https://jupyterlite.github.io/terminal" target="_blank">[open in new tab]</a></p>
        </section>

        <section>
          <h2>Demo of JupyterLite Terminal 2</h2>
          <div class="single-column">
            <ul>
              <li>Access the shared JupyterLite file system</li>
              <li>List commands available</li>
              <li>Editors <code>vim</code> and <code>nano</code></li>
              <li><code>uname -a</code> shows it is an Emscripten build</li>
              <li><code>cockle-config package</code> shows installed Emscripten-Forge packages</li>
            </ul>
          </div>
        </section>

        <section>
          <h2>vim Emscripten-Forge package</h2>
          <div class="two-column">
            <div class="column">
              <p><a href="https://github.com/emscripten-forge/recipes/blob/main/recipes/recipes_emscripten/vim/recipe.yaml" target="_blank">recipe.yaml</a></p>
              <pre style="width: 100%;"><code data-trim data-line-numbers class="language-yaml">
                context:
                  version: 9.1.0917

                package:
                  name: vim
                  version: ${{ version }}

                source:
                  url: https://github.com/vim/vim/archive/refs/tags/v${{ version }}.tar.gz
                  sha256: a5cdcfcfeb13dc4deddcba461d40234dbf47e61941cb7170c9ebe147357bb62d
                  patches:
                    - patches/0001-const-char-args.patch

                build:
                  number: 4

                requirements:
                  build:
                    - ${{ compiler("c") }}
                  host:
                    - ncurses &lt;6.5

                tests:
                  - script:
                    - test -f $PREFIX/bin/vim.data
                    - test -f $PREFIX/bin/vim.js
                    - test -f $PREFIX/bin/vim.wasm
                  - script: |
                      # Limit output to exclude compilation date and time.
                      OUTPUT=$(run_modularized $PREFIX/bin/vim.js --version | head -1 | cut -c -22)
                      if [[ "$OUTPUT" != "VIM - Vi IMproved 9.1 " ]]; then
                        echo "Unexpected output: $OUTPUT"
                        exit 1
                      fi
                    requirements:
                      build:
                        - run_modularized >= 0.1.2

                about:
                  license: Vim
                  license_file: LICENSE

                extra:
                  recipe-maintainers:
                    - ianthomas23
              </code></pre>
              <p>
                <ul>
                  <li>Source from official <code>vim</code> repo</li>
                  <li>Small patch</li>
                  <li>Depends on <code>ncurses</code></li>
                </ul>
              </p>
            </div>
            <div class="column">
              <p><a href="https://github.com/emscripten-forge/recipes/blob/main/recipes/recipes_emscripten/vim/build.sh" target="_blank">build.sh</a></p>
              <pre style="width: 100%;"><code data-trim data-line-numbers class="language-bash">
                export NCURSES_CFLAGS=$($PREFIX/bin/ncurses6-config --cflags)
                export NCURSES_LDFLAGS=$($PREFIX/bin/ncurses6-config --libs-only-L)
                export XTERM_256COLOR=$($PREFIX/bin/ncurses6-config --terminfo)/x/xterm-256color
                export VIMRC=$PWD/vimrc

                echo $NCURSES_CFLAGS
                echo $NCURSES_LDFLAGS
                ls -l $XTERM_256COLOR

                export CONFIG_CFLAGS="\
                    $NCURSES_CFLAGS \
                    -Os \
                    "
                export CONFIG_LDFLAGS="\
                    $NCURSES_LDFLAGS \
                    -Os \
                    --minify=0 \
                    -sALLOW_MEMORY_GROWTH=1 \
                    -sEXIT_RUNTIME=1 \
                    -sEXPORTED_RUNTIME_METHODS=FS,ENV,getEnvStrings,TTY \
                    -sFORCE_FILESYSTEM=1 \
                    -sMODULARIZE=1 \
                    -sLZ4 \
                    "

                emconfigure ./configure \
                    --disable-nls \
                    --disable-xattr \
                    --host=wasm32-unknown-emscripten \
                    --with-compiledby=emscripten-forge \
                    --with-features=normal \
                    --with-tlib=tinfo \
                    CFLAGS="$CFLAGS $CONFIG_CFLAGS" \
                    LDFLAGS="$LDFLAGS $CONFIG_LDFLAGS" \
                    ac_cv_sizeof_int=4 \
                    ac_cv_sizeof_long=8 \
                    ac_cv_sizeof_off_t=4 \
                    ac_cv_sizeof_time_t=4 \
                    ac_cv_func_ftruncate=no

                # Use /etc/vimrc for system vimrc file and turn some features on and off.
                sed -ri "s/.*(#define SYS_VIMRC_FILE\s.*)/\1/" src/feature.h
                echo "syntax on" > $VIMRC
                echo "set termguicolors" >> $VIMRC
                echo "set nobackup" >> $VIMRC
                echo "set noswapfile" >> $VIMRC
                echo "set nowritebackup" >> $VIMRC

                # Installs runtime config files under $PWD/usr/local/share/vim
                DESTDIR=$PWD make -C src installruntime

                emmake make EXEEXT=.js -j4 LDFLAGS=" \
                    $LDFLAGS \
                    $CONFIG_LDFLAGS \
                    --preload-file $PWD/usr/local/share/vim/vim91@/usr/local/share/vim/vim91 \
                    --exclude-file $PWD/usr/local/share/vim/vim91/lang \
                    --exclude-file $PWD/usr/local/share/vim/vim91/doc \
                    --exclude-file $PWD/usr/local/share/vim/vim91/tutor \
                    --preload-file $XTERM_256COLOR@/usr/local/share/terminfo/x/xterm-256color \
                    --preload-file $VIMRC@/etc/vimrc \
                    "

                mkdir -p $PREFIX/bin
                cp src/vim.{data,js,wasm} $PREFIX/bin/
              </code></pre>
              <p>
                <ul>
                  <li><code>configure</code> and <code>make</code> steps</li>
                  <li>Creates <code>vim.js</code>, <code>vim.wasm</code> and <code>vim.data</code></li>
                </ul>
              </p>
            </div>
          </div>
        </section>

        <section>
          <h2>Looking ahead: git</h2>
          <div class="two-column">
            <div class="column" style="width: 50%;">
              <ul>
                <li><a href="https://github.com/QuantStack/git2cpp">git2cpp</a> (C++) wraps <a href="https://github.com/libgit2/libgit2">libgit2</a> (C) to provide command-line tools</li>
                <li>Emscripten Forge builds patched to communicate with remote hosts</li>
                <li>Basic functionality almost ready ...</li>
                <li>Incrementally add new functionality</li>
              </ul>
            </div>
            <div class="column">
              <img src="/src/images/terminal-git.png" alt="git2cpp running in cockle">
            </div>
            </div>
        </section>

        <section>
          <h2>Questions?</h2>
          <div class="two-column">
            <div class="column" style="width: 60%;">
              <img src="/src/images/cosmo_rocket.png" alt="QuantStack Logo">
              <h3 class="main-title">Thank You!</h3>
            </div>
            <div class="column">
              <img src="/src/images/qr-code.svg" alt="QR code for slides"  style="margin: 2em;">
              <p><a href="https://isabelparedes.github.io/pydata2025/" target="_blank">IsabelParedes.github.io/pydata2025/</a></p>
            </div>
          </div>
        </section>

      </div>
		</div>

  </body>
</html>
